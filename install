#!/bin/sh

mkdir -p ~/.config

printf "Checking if HOME is parent of current dir...\n"

dotfiles=$(pwd)

cd ..
parent=$(pwd)

cd "$dotfiles"

if [ "$parent" = "$HOME" ]; then
    printf "Parent is HOME, continuing\n"
else
    printf "Parent is not HOME!!\n"
    exit 1
fi

printf "Installing programs...\n"

pkg_cmd="sudo apt-get install -y" # Default

if [ -n "$TERMUX_VERSION" ]; then
    pkg_cmd="pkg i -y"
    pkgs="build-essential x11-repo stow emacs-x ripgrep fzf"
elif [ "$(uname)" = "Darwin" ]; then
    pkg_cmd="brew install"
    pkgs="gcc make fzf ripgrep stow"
    casks="google-chrome emacs-app"
elif [ "$(uname)" = "Linux" ]; then
    . /etc/os-release
    if [ "$ID_LIKE" = "debian" ]; then
	pkg_cmd="sudo apt-get install -y"
	pkgs="build-essential emacs fzf stow ripgrep"
    else
	printf "Unsupported distro!!\n"
	exit 1
    fi
else
    printf "Unsupported OS!!\n"
    exit 1
fi

# On macOS, get homebrew first
if [ "$(uname)" = "Darwin" ]; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# Perform the installation
printf "Running: $pkg_cmd $pkgs\n"
$pkg_cmd $pkgs

# Special case for macOS (Homebrew casks)
if [ "$(uname)" = "Darwin" ] && [ -n "$casks" ]; then
    printf "Installing casks: $casks\n"
    brew install --cask $casks
fi

if [ -x "$(command -v stow)" ]; then
    printf "Continuing to main logic\n"
else
    printf "Stow is not installed!!\n"
    exit 1
fi

printf "Do you want to install every package, or only some? (answer every or some): "

read -r answer

if [ "$answer" = "every" ]; then
    rm ~/.config/starship.toml -f
    rm ~/.emacs.d/init.el -f 
    rm ~/.emacs.d/config.org -f
    rm ~/.zshrc -f
    rm ~/.tmux.conf -f
    rm ~/.nanorc -f
    rm -rf ~/.emacs.d/lisp
    stow */
elif [ "$answer" = "some" ]; then
    printf "Package to install?: "
    read -r package
    if [ "$package" = "" ]; then
	printf "No package!!\n"
	exit 1
    fi
    stow $package
else
    printf "Bad answer!!\n"
    exit 1
fi
